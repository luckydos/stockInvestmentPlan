<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Stock Investment Plan</title>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css"/>

	<style>
		:root {
			--bg-body: #f5f7fa;
			--bg-card: #ffffff;
			--text-main: #333333;
			--text-sub: #666666;

			/* [디자인] 테두리 색상 (깔끔한 회색) */
			--border-color: #dce1e6;

			/* [디자인] 목표 입력란 배경색 (튀지 않는 은은한 회색) */
			--input-bg: #f8f9fa;
			--input-text: #495057;

			/* [디자인] 헤더 배경 */
			--header-bg: #f1f3f5;

			--color-up: #e31b23;
			--color-down: #0051c7;

			--badge-buy: #e31b23;
			--badge-sell: #0051c7;
			--badge-hold: #868e96;

			--tab-active-text: #111;
			--tab-inactive-bg: #ebTeff;
			--tab-inactive-text: #999;
		}

		body {
			font-family: 'Pretendard', sans-serif;
			background-color: var(--bg-body);
			margin: 0;
			padding: 40px 20px;
			color: var(--text-main);
		}

		.container {
			max-width: 1600px;
			margin: 0 auto;
		}

		/* --- 헤더 --- */
		.dashboard-header {
			margin-bottom: 20px;
			text-align: center;
		}

		.dashboard-title h2 {
			margin: 0;
			font-size: 28px;
			font-weight: 800;
			color: #2c3e50;
			letter-spacing: -0.5px;
		}

		/* --- 툴바 (탭 영역) --- */
		.toolbar {
			display: flex;
			justify-content: space-between;
			align-items: flex-end;
			/* [수정] 패딩 제거 -> 왼쪽 라인 완벽 일치 */
			padding: 0;
			/* 탭이 본문 보더 위로 올라가게 */
			margin-bottom: -1px;
			position: relative;
			z-index: 10;
		}

		.tabs-group {
			display: flex;
			gap: 4px;
		}

		.tab-btn {
			padding: 12px 30px;
			border: 1px solid transparent;
			border-bottom: none;
			/* 비활성 탭 배경 (투명하거나 연한 회색) */
			background: #e9ecef;
			border-radius: 12px 12px 0 0;
			font-size: 15px;
			font-weight: 600;
			color: var(--tab-inactive-text);
			cursor: pointer;
			transition: all 0.1s ease;
			display: flex;
			align-items: center;
			justify-content: center; /* 가운데 정렬 확실하게 */
			gap: 4px;
			position: relative;
			display: flex;
		}

		.tab-btn:hover {
			background-color: #dee2e6;
			color: var(--text-main);
		}

		/* [핵심 수정] 활성 탭 디자인 (일체감) */
		.tab-btn.active {
			background-color: var(--bg-card);
			color: var(--tab-active-text);
			font-weight: 700;
			/* 테두리 색상 통일 */
			border: 1px solid var(--border-color);
			/* 하단을 흰색으로 덮어 본문과 연결 */
			border-bottom: 1px solid var(--bg-card);
			z-index: 20;
			padding-bottom: 13px;
			/* 높이 보정 */
			box-shadow: 0 -2px 3px rgba(0, 0, 0, 0.02);
		}

		/* 국기 아이콘 스타일 조정 */
		.fi {
			font-size: 18px;     /* 국기 크기 */
			margin-right: 6px;   /* 텍스트와의 간격 */
			border-radius: 2px;  /* 국기 모서리 살짝 둥글게 */
			box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* 국기 입체감 */
		}
		
		/* 탭 버튼 정렬 보정 */
		.tab-btn {
		/* 기존 코드 유지... */

		}

		/* 시간 표시 */
		.time-display {
			font-size: 13px;
			color: #666;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 6px;
			background: #fff;
			padding: 6px 16px;
			border-radius: 20px;
			border: 1px solid var(--border-color);
			margin-bottom: 8px;
			/* 탭 높이와 균형 */
		}

		.time-display i {
			color: #2c3e50;
		}

		/* --- 컨텐츠 박스 --- */
		.content-section {
			display: none;
			background: var(--bg-card);
			border: 1px solid var(--border-color);
			/* 왼쪽 위는 직각(탭 연결), 나머지는 둥글게 */
			border-radius: 0 12px 12px 12px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
			padding: 20px;
			animation: fadeIn 0.2s ease-out;
			position: relative;
			z-index: 5;
		}

		.content-section.active {
			display: block;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(5px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* --- 테이블 디자인 (Grid 스타일) --- */
		.table-responsive {
			overflow-x: auto;
			width: 100%;
			/* 테이블 외곽선 */
			border: 1px solid var(--border-color);
			border-radius: 8px;
		}

		table {
			width: 100%;
			/* sticky header를 위해 separate 유지하되 간격(spacing)을 0으로 */
			border-collapse: separate;
			border-spacing: 0;
			min-width: 1400px;
		}

		th {
			background-color: var(--header-bg);
			color: #333;
			font-weight: 700;
			padding: 14px 10px;
			text-align: center;
			/* 테두리: 아래와 오른쪽 */
			border-bottom: 1px solid var(--border-color);
			border-right: 1px solid var(--border-color);
			white-space: nowrap;
			position: sticky;
			top: 0;
			z-index: 10;
			font-size: 14px;
		}

		/* 마지막 헤더 오른쪽 선 제거 */
		th:last-child {
			border-right: none;
		}

		td {
			padding: 12px 10px;
			/* 테두리: 아래와 오른쪽 */
			border-bottom: 1px solid var(--border-color);
			border-right: 1px solid var(--border-color);
			vertical-align: middle;
			text-align: right;
			font-size: 14px;
			white-space: nowrap;
			color: #333;
		}

		/* 마지막 열 오른쪽 선 제거 */
		td:last-child {
			border-right: none;
		}

		/* 마지막 행 아래 선 제거 */
		tbody tr:last-child td {
			border-bottom: none;
		}

		/* 행 호버 효과 */
		tbody tr:hover td {
			background-color: #f8faff !important;
		}


		/* --- [수정] 목표값 컬럼 디자인 (자연스럽게) --- */
		/* 배경색을 아주 연한 회색으로 하여 이질감 제거 */
		.input-val {
			background-color: var(--input-bg) !important;
			color: var(--input-text);
			/* 테두리 색상은 다른 셀과 동일하게 하여 통일감 부여 */
			border-right: 1px solid var(--border-color);
		}

		/* 입력값 헤더 */
		th.input-val {
			background-color: #e9ecef;
			/* 헤더보다 살짝 진하게 */
			color: #333;
		}


		/* --- 고정 컬럼 (기업명) --- */
		th:first-child,
		td:first-child {
			position: sticky;
			left: 0;
			z-index: 20;
			background-color: #fff;
			/* 오른쪽 테두리를 조금 더 진하게 주어 구분감 형성 */
			border-right: 1px solid #bdc3c7;
			text-align: left;
			padding-left: 20px;
		}

		th:first-child {
			z-index: 30;
			background-color: var(--header-bg);
			/* 탭 연결 부위: 왼쪽 위 둥글기 제거 */
			border-top-left-radius: 0;
		}

		/* 기업명 텍스트 */
		.stock-name {
			font-weight: 700;
			color: #212529;
			font-size: 15px;
			display: block;
		}

		.stock-code {
			font-size: 12px;
			color: #adb5bd;
			margin-top: 4px;
			display: block;
			font-weight: 400;
		}


		/* --- UI 요소 --- */
		.badge {
			display: inline-block;
			padding: 6px 12px;
			border-radius: 6px;
			font-size: 12px;
			font-weight: 700;
			color: white;
			text-align: center;
			min-width: 52px;
		}

		.badge.buy {
			background: var(--badge-buy);
		}

		.badge.sell {
			background: var(--badge-sell);
		}

		.badge.hold {
			background-color: var(--badge-hold);
			opacity: 0.8;
		}

		.badge.nodata {
			background-color: #e9ecef;
			color: #adb5bd;
		}

		.up {
			color: var(--color-up);
			font-weight: 700;
		}

		.down {
			color: var(--color-down);
			font-weight: 700;
		}

		.price-text {
			font-family: 'Roboto', sans-serif;
			font-weight: 600;
		}

		.graph-wrapper {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 10px;
			width: 140px;
			margin-left: auto;
		}

		.graph-text {
			width: 50px;
			text-align: right;
			font-size: 13px;
		}

		.bar-track {
			flex-grow: 1;
			height: 6px;
			background-color: #eee;
			border-radius: 3px;
			overflow: hidden;
			display: flex;
			position: relative;
		}

		.bar-fill {
			height: 100%;
			border-radius: 3px;
			transition: width 0.5s ease;
		}

		.loading-row td {
			text-align: center;
			color: #999;
			padding: 60px;
			border: none;
		}

		.spinner {
			display: inline-block;
			width: 24px;
			height: 24px;
			border: 3px solid rgba(0, 0, 0, 0.1);
			border-radius: 50%;
			border-top-color: #2c3e50;
			animation: spin 1s ease-in-out infinite;
			vertical-align: middle;
			margin-right: 10px;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		@media (max-width: 768px) {
			.container {
				margin: 0;
			}

			.toolbar {
				flex-direction: column-reverse;
				align-items: flex-start;
				gap: 10px;
				padding: 0;
			}

			.time-display {
				width: 100%;
				justify-content: center;
				background: #fff;
				margin-bottom: 0;
			}

			.tabs-group {
				width: 100%;
				gap: 8px;
			}

			.tab-btn {
				flex: 1;
				justify-content: center;
				border-radius: 12px;
				border: 1px solid var(--border-color);
				background: #fff;
			}

			.tab-btn.active {
				background: #2c3e50;
				color: #fff;
				border: none;
			}

			td:first-child {
				padding-left: 15px;
			}
		}
	</style>
</head>

<body>

	<div class="container">
		<div class="dashboard-header">
			<div class="dashboard-title">
				<h2>Stock Investment Plan <span>포트폴리오 현황</span></h2>
			</div>
		</div>

		<div class="toolbar">
			<div class="tabs-group">
				<button class="tab-btn active" onclick="switchTab('korea')">
					<span class="fi fi-kr"></span> 한국 주식
				</button>
				<button class="tab-btn" onclick="switchTab('usa')">
					<span class="fi fi-us"></span> 미국 주식
				</button>
			</div>
			<div class="time-display">
				<i class="far fa-clock"></i>
				<span id="globalTime">업데이트 대기중...</span>
			</div>
		</div>

		<div id="korea" class="content-section active">
			<div class="table-responsive">
				<table id="tableKorea">
					<thead>
						<tr>
							<th>기업명</th>
							<th class="input-val">목표<br>배당률(%)</th>
							<th class="input-val">목표<br>PER(배)</th>
							<th>Action</th>
							<th>목표가</th>
							<th>현재가</th>
							<th>등락률</th>
							<th>52주 최고</th>
							<th>고점 대비</th>
							<th>시가총액</th>
							<th>PER</th>
							<th>EPS</th>
							<th>PBR</th>
							<th>배당률</th>
							<th>배당금</th>
							<th>배당성향</th>
						</tr>
					</thead>
					<tbody id="tbodyKorea"></tbody>
				</table>
			</div>
		</div>

		<div id="usa" class="content-section">
			<div class="table-responsive">
				<table id="tableUSA">
					<thead>
						<tr>
							<th>기업명</th>
							<th class="input-val">목표<br>배당률(%)</th>
							<th class="input-val">목표<br>PER(배)</th>
							<th>Action</th>
							<th>목표가</th>
							<th>현재가</th>
							<th>등락률</th>
							<th>52주 최고</th>
							<th>고점 대비</th>
							<th>시가총액<br><span style="font-weight:400; color:#999; font-size:0.85em">(AUM)</span></th>
							<th>PER</th>
							<th>EPS</th>
							<th>PBR</th>
							<th>배당률</th>
							<th>배당금</th>
							<th>배당성향</th>
						</tr>
					</thead>
					<tbody id="tbodyUSA"></tbody>
				</table>
			</div>
		</div>
	</div>

	<script>
		// ============================================================
		// 1. [설정] Google Apps Script URL
		// ============================================================
		const API_URL = "https://script.google.com/macros/s/AKfycbz80x6AyIftaDyqX68cyv3spp2x8gg14Rq1gPnb8NSToi0LInPgOkBbn2lflJSkd_8u/exec";

		// ============================================================
		// 2. [설정] 종목 및 목표 설정
		// ============================================================
		const koreaStocks = [
			{ name: "기아", code: "000270", targetDiv: 6.00, targetPer: null },
			{ name: "삼성증권", code: "016360", targetDiv: 5.00, targetPer: null },
			{ name: "KT&G", code: "033780", targetDiv: 4.00, targetPer: null },
			{ name: "한전KPS", code: "051600", targetDiv: 5.00, targetPer: null },
			{ name: "메리츠금융지주", code: "138040", targetDiv: null, targetPer: 10 }
		];

		const usaStocks = [
			{ name: "Cisco Systems", code: "CSCO", targetDiv: 3.00, targetPer: null },
			{ name: "Coca-Cola", code: "KO", targetDiv: 3.00, targetPer: null },
			{ name: "Realty Income", code: "O", targetDiv: 6.00, targetPer: null },
			{ name: "Pfizer", code: "PFE", targetDiv: 7.00, targetPer: null },
			{ name: "iShares 20+ Year Treasury Bond ETF", code: "TLT", targetDiv: 4.30, targetPer: null }
		];

		// ============================================================
		// 3. 로직 함수
		// ============================================================
		function calculateTarget(data, config) {
			try {
				if (config.targetDiv) {
					if (!data.divAmt) return 0;
					return data.divAmt / (config.targetDiv / 100);
				}
				if (config.targetPer) {
					if (!data.eps) return 0;
					return data.eps * config.targetPer;
				}
				return "no data";
			} catch (e) {
				return "err";
			}
		}

		function getAction(current, target) {
			if (typeof target === 'string') return { text: "판단불가", class: "nodata" };
			if (!current) return { text: "로딩중", class: "nodata" };

			if (current < target) return { text: "매수", class: "buy" };
			else if (current > target * 1.2) return { text: "매도", class: "sell" };
			else return { text: "보유", class: "hold" };
		}

		async function fetchAndRender(country) {
			const tableId = country === 'korea' ? 'tbodyKorea' : 'tbodyUSA';
			const stockList = country === 'korea' ? koreaStocks : usaStocks;
			const tbody = document.getElementById(tableId);
			const isKorea = country === 'korea';

			tbody.innerHTML = `<tr class="loading-row"><td colspan="16"><div class="spinner"></div>데이터를 불러오는 중입니다...</td></tr>`;

			const promises = stockList.map(item =>
				fetch(`${API_URL}?ticker=${item.code}`)
					.then(res => res.json())
					.then(data => {
						const calculatedTarget = calculateTarget(data, item);
						return { ...data, name: item.name, targetDiv: item.targetDiv, targetPer: item.targetPer, targetPrice: calculatedTarget };
					})
					.catch(err => ({ ...item, error: true }))
			);

			try {
				const rowDataList = await Promise.all(promises);

				const validData = rowDataList.find(d => !d.error && d.time);
				if (validData) {
					const timeStr = validData.time;
					window[`time_${country}`] = timeStr;
					if (document.querySelector('.tab-btn.active').innerText.includes(isKorea ? "한국" : "미국")) {
						document.getElementById('globalTime').innerText = timeStr;
					}
				}
				renderTableBody(tbody, rowDataList, isKorea);

			} catch (error) {
				tbody.innerHTML = `<tr><td colspan="16" style="text-align:center;">데이터 로드 실패</td></tr>`;
			}
		}

		function renderTableBody(tbody, dataList, isKorea) {
			tbody.innerHTML = "";
			const maxChange = Math.max(...dataList.map(d => d.changeRate ? Math.abs(d.changeRate) : 0)) || 0.01;
			const maxDrop = Math.max(...dataList.map(d => d.dropRate ? Math.abs(d.dropRate) : 0)) || 0.01;

			dataList.forEach(item => {
				if (item.error) {
					tbody.innerHTML += `<tr><td>${item.name}</td><td colspan="15">호출 실패</td></tr>`;
					return;
				}

				const action = getAction(item.price, item.targetPrice);
				const currency = isKorea ? "₩" : "$";
				const fmt = (n) => n ? n.toLocaleString(undefined, { maximumFractionDigits: 0 }) : "-";
				const fmtUsd = (n) => n ? n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "-";
				const fmtPct = (n) => n ? (n * 100).toFixed(2) + "%" : "0.00%";

				const displayPrice = isKorea ? fmt(item.price) : fmtUsd(item.price);
				const displayTarget = typeof item.targetPrice === 'number' ? (isKorea ? fmt(item.targetPrice) : fmtUsd(item.targetPrice)) : "-";

				const changeVal = item.changeRate || 0;
				const changeColor = changeVal < 0 ? "#0051c7" : "#e31b23";
				const changeWidth = (Math.abs(changeVal) / maxChange) * 100;

				const dropVal = item.dropRate || 0;
				const dropColor = "#0051c7";
				const dropWidth = (Math.abs(dropVal) / maxDrop) * 100;

				let marketCapDisplay = item.marketCap;
				if (marketCapDisplay && marketCapDisplay.includes("조 ")) {
					marketCapDisplay = marketCapDisplay.replace("조 ", "조<br>");
				}

				const tr = `
                    <tr>
                        <td>
                            <span class="stock-name">${item.name}</span>
                            <span class="stock-code">${item.ticker || item.code}</span>
                        </td>
                        <td class="input-val">${item.targetDiv ? item.targetDiv.toFixed(2) + "%" : ""}</td>
                        <td class="input-val">${item.targetPer ? item.targetPer : ""}</td>
                        
                        <td style="text-align:center;"><span class="badge ${action.class}">${action.text}</span></td>
                        <td class="price-text" style="color:#2c3e50;">${currency}${displayTarget}</td>
                        <td class="price-text" style="font-weight:700;">${currency}${displayPrice}</td>
                        
                        <td>
                            <div class="graph-wrapper">
                                <span class="graph-text ${changeVal > 0 ? 'up' : (changeVal < 0 ? 'down' : '')}">${fmtPct(changeVal)}</span>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width:${changeWidth}%; background-color:${changeColor}; margin-${changeVal < 0 ? 'left' : 'right'}: auto;"></div>
                                </div>
                            </div>
                        </td>

                        <td class="price-text">${currency}${isKorea ? fmt(item.high52) : fmtUsd(item.high52)}</td>

                        <td>
                            <div class="graph-wrapper">
                                <span class="graph-text down">${fmtPct(dropVal)}</span>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width:${dropWidth}%; background-color:${dropColor}; margin-left: auto;"></div>
                                </div>
                            </div>
                        </td>

                        <td style="line-height:1.3">${marketCapDisplay}</td>
                        <td>${item.per || '-'}</td>
                        <td class="price-text">${isKorea ? '₩' : '$'}${isKorea ? fmt(item.eps) : fmtUsd(item.eps)}</td>
                        <td>${item.pbr || '-'}</td>
                        <td style="color:#e31b23; font-weight:600;">${fmtPct(item.divYield)}</td>
                        <td class="price-text">${isKorea ? '₩' : '$'}${isKorea ? fmt(item.divAmt) : fmtUsd(item.divAmt)}</td>
                        <td>${fmtPct(item.payout)}</td>
                    </tr>
                `;
				tbody.innerHTML += tr;
			});
		}

		function switchTab(country) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			event.currentTarget.classList.add('active');
			document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
			document.getElementById(country).classList.add('active');

			const savedTime = window[`time_${country}`];
			document.getElementById('globalTime').innerText = savedTime || "업데이트 중...";
		}

		window.onload = () => {
			fetchAndRender('korea');
			fetchAndRender('usa');
		};
	</script>
</body>

</html>
