<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Stock Investment Plan</title>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css" />

	<style>
		/* 모든 요소의 너비 계산에 패딩/테두리 포함 */
		* {
			box-sizing: border-box;
		}

		:root {
			--bg-body: #f5f7fa;
			--bg-card: #ffffff;
			--text-main: #333333;
			--text-sub: #666666;
			--border-color: #e0e0e0;
			--header-bg: #f8f9fa;
			--color-up: #e31b23;
			--color-down: #0051c7;
			--badge-buy: #e31b23;
			--badge-sell: #0051c7;
			--badge-hold: #868e96;
			--tab-active-text: #111;
			--tab-inactive-bg: #f1f3f5;
			--tab-inactive-text: #999;
		}

		body {
			font-family: 'Pretendard', sans-serif;
			background-color: var(--bg-body);
			margin: 0;
			padding: 40px 15px;
			color: var(--text-main);
			transition: background-color 0.3s ease;
			overflow-y: scroll;
			overflow-x: hidden;
			/* 전체 가로 스크롤 방지 */
		}

		.container {
			max-width: 1600px;
			margin: 0 auto;
			transition: all 0.3s ease;
			width: 100%;
		}

		/* --- 공통 유틸리티 --- */
		.up {
			color: var(--color-up) !important;
			font-weight: 700;
		}

		.down {
			color: var(--color-down) !important;
			font-weight: 700;
		}

		.badge {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 6px;
			font-size: 12px;
			font-weight: 700;
			color: white;
			text-align: center;
			min-width: 50px;
		}

		.badge.buy {
			background: var(--badge-buy);
		}

		.badge.sell {
			background: var(--badge-sell);
		}

		.badge.hold {
			background: var(--badge-hold);
		}

		.badge.nodata {
			background: #e9ecef;
			color: #adb5bd;
		}

		/* --- 헤더 & 버튼 --- */
		.dashboard-header {
			margin-bottom: 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.dashboard-title h2 {
			margin: 0;
			font-size: 28px;
			font-weight: 800;
			color: #2c3e50;
		}

		.btn-group {
			display: flex;
			gap: 8px;
		}

		.action-btn {
			background: #fff;
			border: 1px solid var(--border-color);
			border-radius: 8px;
			padding: 10px 16px;
			font-weight: 600;
			cursor: pointer;
			display: flex;
			gap: 6px;
			align-items: center;
			color: var(--text-sub);
			transition: all 0.2s;
			white-space: nowrap;
		}

		.action-btn:hover {
			background: #f8f9fa;
			color: #333;
			border-color: #bbb;
		}

		.toolbar {
			display: flex;
			justify-content: space-between;
			align-items: flex-end;
			margin-bottom: -1px;
			position: relative;
			z-index: 10;
		}

		.tabs-group {
			display: flex;
			gap: 0;
		}

		.tab-btn {
			padding: 12px 30px;
			border: 1px solid transparent;
			border-bottom: none;
			background: var(--tab-inactive-bg);
			border-radius: 12px 12px 0 0;
			font-weight: 600;
			color: var(--tab-inactive-text);
			cursor: pointer;
			margin-right: 4px;
			display: flex;
			gap: 8px;
			align-items: center;
		}

		.tab-btn.active {
			background: var(--bg-card);
			color: var(--tab-active-text);
			font-weight: 700;
			border: 1px solid var(--border-color);
			border-bottom: 1px solid var(--bg-card);
			z-index: 20;
			padding-bottom: 13px;
		}

		.time-display {
			font-size: 13px;
			color: #666;
			background: #fff;
			padding: 6px 16px;
			border-radius: 20px;
			border: 1px solid var(--border-color);
			margin-bottom: 8px;
		}

		.content-section {
			display: none;
			background: var(--bg-card);
			border: 1px solid var(--border-color);
			border-radius: 0 12px 12px 12px;
			padding: 20px;
		}

		.content-section.active {
			display: block;
		}

		/* --- PC View Styles --- */
		.pc-view {
			display: block;
		}

		.mobile-view {
			display: none;
		}

		/* 테이블 래퍼: 스크롤바 자체를 숨김 처리하여 깔끔하게 (내용은 잘릴 수 있음 -> 툴팁으로 해결) */
		.table-responsive {
			width: 100%;
			border: 1px solid var(--border-color);
			border-radius: 8px;
			overflow: hidden;
			/* 강제로 스크롤 숨김 */
		}

		table {
			/* [핵심 수정] min-width 제거하여 무조건 100% 맞춤 */
			table-layout: fixed;
			width: 100%;
			/* min-width: 1200px;  <-- 이 부분을 삭제했습니다 */
			border-collapse: separate;
			border-spacing: 0;
		}

		th {
			background: var(--header-bg);
			padding: 16px 8px;
			text-align: center;
			border-bottom: 1px solid var(--border-color);
			border-right: 1px solid var(--border-color);
			position: sticky;
			top: 0;
			z-index: 10;
			white-space: nowrap;
			font-size: 14px;
			overflow: hidden;
			text-overflow: ellipsis;
			/* 헤더도 넘치면 ... 처리 */
		}

		td {
			padding: 14px 8px;
			/* 패딩을 살짝 줄여 공간 확보 */
			border-bottom: 1px solid var(--border-color);
			border-right: 1px solid var(--border-color);
			text-align: right;
			font-size: 14px;
			color: #333;
			vertical-align: middle;

			/* [핵심] 내용이 칸보다 길면 ... 처리 */
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		/* [고정 컬럼] */
		th:first-child,
		td:first-child {
			position: sticky;
			left: 0;
			z-index: 20;
			background: #fff;
			text-align: center;
			border-right: 1px solid var(--border-color);
		}

		th:first-child {
			z-index: 30;
			background: var(--header-bg);
		}

		.stock-name {
			font-weight: 700;
			color: #212529;
			font-size: 15px;
			display: block;
			width: 100%;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.input-val {
			background-color: #fcfcfc;
			color: #495057;
			text-align: center;
		}

		.graph-wrapper {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 6px;
			width: 100%;
			/* 그래프 영역도 유동적으로 */
			margin-left: auto;
		}

		.bar-track {
			flex-grow: 1;
			height: 6px;
			background: #eee;
			border-radius: 3px;
			overflow: hidden;
			display: flex;
			min-width: 30px;
		}

		.bar-fill {
			height: 100%;
			border-radius: 4px;
		}

		/* --- Mobile View Styles (Card) --- */
		.mobile-card {
			background: #fff;
			border: 1px solid var(--border-color);
			border-radius: 12px;
			padding: 16px;
			margin-bottom: 16px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
		}

		.m-header {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			margin-bottom: 12px;
			padding-bottom: 12px;
			border-bottom: 1px solid #f0f0f0;
		}

		.m-stock-info h3 {
			margin: 0;
			font-size: 18px;
			font-weight: 700;
			color: #2c3e50;
		}

		.m-stock-info span {
			font-size: 13px;
			color: #adb5bd;
			margin-top: 2px;
			display: block;
		}

		.m-body {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.m-price-row {
			display: flex;
			justify-content: space-between;
			align-items: flex-end;
		}

		.m-current-price {
			font-size: 24px;
			font-weight: 800;
			color: #333;
			letter-spacing: -0.5px;
		}

		.m-target-price {
			font-size: 13px;
			color: #888;
			text-align: right;
		}

		.m-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 10px;
			background: #f8f9fa;
			padding: 12px;
			border-radius: 8px;
		}

		.m-grid-item {
			text-align: center;
		}

		.m-grid-label {
			display: block;
			font-size: 11px;
			color: #888;
			margin-bottom: 4px;
		}

		.m-grid-value {
			display: block;
			font-size: 14px;
			font-weight: 600;
			color: #333;
		}

		.m-footer {
			margin-top: 8px;
			display: flex;
			gap: 10px;
		}

		.m-bar-group {
			flex: 1;
		}

		.m-bar-label {
			display: flex;
			justify-content: space-between;
			font-size: 11px;
			color: #666;
			margin-bottom: 4px;
		}

		.m-bar-bg {
			height: 6px;
			background: #eee;
			border-radius: 3px;
			overflow: hidden;
		}

		.m-bar-fill {
			height: 100%;
			border-radius: 3px;
		}

		.spinner {
			display: block;
			width: 32px;
			height: 32px;
			margin: 0;
			border: 3px solid rgba(0, 0, 0, 0.1);
			border-radius: 50%;
			border-top-color: #2c3e50;
			animation: spin 1s infinite linear;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		.loading-msg {
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			gap: 15px;
			min-height: 50vh;
			width: 100%;
			color: #868e96;
			font-weight: 500;
			font-size: 15px;
		}

		/* ----------------------------------------------------
           [Logic] View Mode Toggle
           ---------------------------------------------------- */
		@media (max-width: 768px) {
			body:not(.force-pc) .pc-view {
				display: none !important;
			}

			body:not(.force-pc) .mobile-view {
				display: block !important;
			}

			body {
				padding: 15px 10px;
				background-color: #f0f2f5;
			}

			.container {
				margin: 0;
				max-width: 100%;
			}

			.dashboard-header {
				flex-direction: column;
				gap: 10px;
				align-items: stretch;
			}

			.btn-group {
				width: 100%;
			}

			.action-btn {
				flex: 1;
				justify-content: center;
			}

			.toolbar {
				flex-direction: column;
				gap: 10px;
			}

			.tabs-group {
				width: 100%;
			}

			.tab-btn {
				flex: 1;
				justify-content: center;
				background: #fff;
				border: 1px solid var(--border-color);
			}

			.tab-btn.active {
				background: #333;
				color: #fff;
				border: 1px solid #333;
			}

			.time-display {
				width: 100%;
				text-align: right;
				background: transparent;
				border: none;
				padding: 0;
			}

			.time-display i {
				display: none;
			}

			.content-section {
				padding: 0;
				background: transparent;
				border: none;
				box-shadow: none;
			}
		}

		body.force-mobile {
			background-color: #2c3e50 !important;
			overflow: hidden;
		}

		body.force-mobile .container {
			max-width: 420px;
			height: 90vh;
			margin: 20px auto;
			background-color: #f0f2f5;
			padding: 20px 15px;
			border-radius: 20px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
			overflow-y: auto;
			display: block;
		}

		body.force-mobile .pc-view {
			display: none !important;
		}

		body.force-mobile .mobile-view {
			display: block !important;
		}

		body.force-mobile .dashboard-header {
			flex-direction: column;
			gap: 10px;
			align-items: stretch;
		}

		body.force-mobile .btn-group {
			width: 100%;
		}

		body.force-mobile .action-btn {
			flex: 1;
			justify-content: center;
		}

		body.force-mobile .toolbar {
			flex-direction: column;
			gap: 10px;
		}

		body.force-mobile .tabs-group {
			width: 100%;
		}

		body.force-mobile .tab-btn {
			flex: 1;
			justify-content: center;
			background: #fff;
			border: 1px solid var(--border-color);
		}

		body.force-mobile .tab-btn.active {
			background: #333;
			color: #fff;
			border: 1px solid #333;
		}

		body.force-mobile .time-display {
			width: 100%;
			text-align: right;
			background: transparent;
			border: none;
			padding: 0;
		}

		body.force-mobile .time-display i {
			display: none;
		}

		body.force-mobile .content-section {
			padding: 0;
			background: transparent;
			border: none;
			box-shadow: none;
		}

		body.force-pc {
			overflow-x: auto; /* 바디 스크롤 허용 (필요시) */
			background-color: var(--bg-body);
		}

		body.force-pc .container {
			width: 100%;
			max-width: 100%;
			padding: 0 5px;
		}

		body.force-pc .pc-view { display: block !important; }

		body.force-pc .mobile-view { display: none !important; }

		body.force-pc .table-responsive {
			display: block;
			width: 100%;
			overflow-x: auto; /* 가로 스크롤 생성 */
			-webkit-overflow-scrolling: touch; /* 부드러운 스크롤 */
		}

		body.force-pc table {
			/* PC 뷰에서는 좁게 찌그러지지 않도록 최소 너비를 줍니다 */
			min-width: 1100px; 
		}
	</style>
</head>

<body>

	<div class="container">
		<div class="dashboard-header">
			<div class="dashboard-title">
				<h2>Stock Investment Plan</h2>
			</div>
			<div class="btn-group">
				<button id="viewToggleBtn" class="action-btn" onclick="toggleViewMode()">
					<i class="fas fa-mobile-alt"></i> <span>모바일 화면</span>
				</button>
				<button class="action-btn" onclick="location.reload()">
					<i class="fas fa-rotate-right"></i> <span>새로고침</span>
				</button>
			</div>
		</div>

		<div class="toolbar">
			<div class="tabs-group">
				<button class="tab-btn active" onclick="switchTab('korea')">
					<span class="fi fi-kr"></span> 한국 주식
				</button>
				<button class="tab-btn" onclick="switchTab('usa')">
					<span class="fi fi-us"></span> 미국 주식
				</button>
			</div>
			<div class="time-display">
				<i class="far fa-clock"></i>
				<span id="globalTime">업데이트 대기중...</span>
			</div>
		</div>

		<div id="korea" class="content-section active">
			<div class="pc-view table-responsive">
				<table id="tableKorea">
					<colgroup>
						<col style="width: 10%;">
						<col style="width: 5%;">
						<col style="width: 5%;">
						<col style="width: 5%;">
						<col style="width: 6%;">
						<col style="width: 7%;">
						<col style="width: 10%;">
						<col style="width: 6%;">
						<col style="width: 10%;">
						<col style="width: 7%;">
						<col style="width: 4%;">
						<col style="width: 6%;">
						<col style="width: 4%;">
						<col style="width: 5%;">
						<col style="width: 5%;">
						<col style="width: 5%;">
					</colgroup>
					<thead>
						<tr>
							<th>기업명</th>
							<th class="input-val">목표<br>배당률(%)</th>
							<th class="input-val">목표<br>PER(배)</th>
							<th>Action</th>
							<th>목표가</th>
							<th>현재가</th>
							<th>등락률</th>
							<th>52주 최고</th>
							<th>고점 대비</th>
							<th>시가총액</th>
							<th>PER</th>
							<th>EPS</th>
							<th>PBR</th>
							<th>배당률</th>
							<th>배당금</th>
							<th>배당성향</th>
						</tr>
					</thead>
					<tbody id="tbodyKorea"></tbody>
				</table>
			</div>
			<div id="listKorea" class="mobile-view"></div>
		</div>

		<div id="usa" class="content-section">
			<div class="pc-view table-responsive">
				<table id="tableUSA">
					<colgroup>
						<col style="width: 10%;">
						<col style="width: 5%;">
						<col style="width: 5%;">
						<col style="width: 5%;">
						<col style="width: 6%;">
						<col style="width: 7%;">
						<col style="width: 10%;">
						<col style="width: 6%;">
						<col style="width: 10%;">
						<col style="width: 7%;">
						<col style="width: 4%;">
						<col style="width: 6%;">
						<col style="width: 4%;">
						<col style="width: 5%;">
						<col style="width: 5%;">
						<col style="width: 5%;">
					</colgroup>
					<thead>
						<tr>
							<th>기업명</th>
							<th class="input-val">목표<br>배당률(%)</th>
							<th class="input-val">목표<br>PER(배)</th>
							<th>Action</th>
							<th>목표가</th>
							<th>현재가</th>
							<th>등락률</th>
							<th>52주 최고</th>
							<th>고점 대비</th>
							<th>시가총액(AUM)</th>
							<th>PER</th>
							<th>EPS</th>
							<th>PBR</th>
							<th>배당률</th>
							<th>배당금</th>
							<th>배당성향</th>
						</tr>
					</thead>
					<tbody id="tbodyUSA"></tbody>
				</table>
			</div>
			<div id="listUSA" class="mobile-view"></div>
		</div>
	</div>

	<script>
		const API_URL = "https://script.google.com/macros/s/AKfycbz80x6AyIftaDyqX68cyv3spp2x8gg14Rq1gPnb8NSToi0LInPgOkBbn2lflJSkd_8u/exec";

		const koreaStocks = [
			{ name: "기아", code: "000270", targetDiv: 6.00, targetPer: null },
			{ name: "삼성증권", code: "016360", targetDiv: 5.00, targetPer: null },
			{ name: "KT&G", code: "033780", targetDiv: 4.00, targetPer: null },
			{ name: "한전KPS", code: "051600", targetDiv: 5.00, targetPer: null },
			{ name: "메리츠금융지주", code: "138040", targetDiv: null, targetPer: 10 }
		];

		const usaStocks = [
			{ name: "Cisco Systems", code: "CSCO", targetDiv: 3.00, targetPer: null },
			{ name: "Coca-Cola", code: "KO", targetDiv: 3.00, targetPer: null },
			{ name: "Realty Income", code: "O", targetDiv: 6.00, targetPer: null },
			{ name: "Pfizer", code: "PFE", targetDiv: 7.00, targetPer: null },
			{ name: "iShares 20+ Treasury", code: "TLT", targetDiv: 4.30, targetPer: null }
		];

		function toggleViewMode() {
			const body = document.body;
			const isPcWidth = window.innerWidth > 768;

			const hasForcePc = body.classList.contains('force-pc');
			const hasForceMobile = body.classList.contains('force-mobile');

			if (isPcWidth) {
				if (hasForceMobile) body.classList.remove('force-mobile');
				else body.classList.add('force-mobile');
			} else {
				if (hasForcePc) body.classList.remove('force-pc');
				else body.classList.add('force-pc');
			}
			updateButtonState();
		}

		function updateButtonState() {
			const body = document.body;
			const btnIcon = document.querySelector('#viewToggleBtn i');
			const btnText = document.querySelector('#viewToggleBtn span');
			const isPcWidth = window.innerWidth > 768;

			const hasForcePc = body.classList.contains('force-pc');
			const hasForceMobile = body.classList.contains('force-mobile');

			if (hasForceMobile) {
				btnIcon.className = "fas fa-desktop";
				btnText.innerText = "PC 화면 복귀";
				return;
			}
			if (hasForcePc) {
				btnIcon.className = "fas fa-mobile-alt";
				btnText.innerText = "모바일 화면 복귀";
				return;
			}

			if (isPcWidth) {
				btnIcon.className = "fas fa-mobile-alt";
				btnText.innerText = "모바일 화면 보기";
			} else {
				btnIcon.className = "fas fa-desktop";
				btnText.innerText = "PC 화면 보기";
			}
		}

		window.addEventListener('resize', () => {
			updateButtonState();
		});

		function calculateTarget(data, config) {
			try {
				if (config.targetDiv) {
					if (!data.divAmt) return 0;
					return data.divAmt / (config.targetDiv / 100);
				}
				if (config.targetPer) {
					if (!data.eps) return 0;
					return data.eps * config.targetPer;
				}
				return "no data";
			} catch (e) { return "err"; }
		}

		function getAction(current, target) {
			if (typeof target === 'string') return { text: "판단불가", class: "nodata" };
			if (!current) return { text: "로딩중", class: "nodata" };
			if (current < target) return { text: "매수", class: "buy" };
			else if (current > target * 1.2) return { text: "매도", class: "sell" };
			else return { text: "보유", class: "hold" };
		}

		async function fetchAndRender(country) {
			const tbody = document.getElementById(country === 'korea' ? 'tbodyKorea' : 'tbodyUSA');
			const mobileList = document.getElementById(country === 'korea' ? 'listKorea' : 'listUSA');
			const stockList = country === 'korea' ? koreaStocks : usaStocks;
			const isKorea = country === 'korea';

			const loadingHtml = `<div class="loading-msg"><div class="spinner"></div> 데이터를 불러오는 중...</div>`;
			tbody.innerHTML = `<tr><td colspan="16" style="text-align:center; padding:50px;">${loadingHtml}</td></tr>`;
			mobileList.innerHTML = loadingHtml;

			const promises = stockList.map(item =>
				fetch(`${API_URL}?ticker=${item.code}`)
					.then(res => res.json())
					.then(data => {
						const calculatedTarget = calculateTarget(data, item);
						return { ...data, name: item.name, targetDiv: item.targetDiv, targetPer: item.targetPer, targetPrice: calculatedTarget };
					})
					.catch(err => ({ ...item, error: true }))
			);

			try {
				const rowDataList = await Promise.all(promises);

				const validData = rowDataList.find(d => !d.error && d.time);
				if (validData) {
					window[`time_${country}`] = validData.time;
					if (document.querySelector('.tab-btn.active').innerText.includes(isKorea ? "한국" : "미국")) {
						document.getElementById('globalTime').innerText = validData.time;
					}
				}

				renderTableBody(tbody, rowDataList, isKorea);
				renderMobileList(mobileList, rowDataList, isKorea);

			} catch (error) {
				console.error(error);
				tbody.innerHTML = `<tr><td colspan="16">로드 실패</td></tr>`;
				mobileList.innerHTML = `<div>로드 실패</div>`;
			}
		}

		function renderTableBody(tbody, dataList, isKorea) {
			tbody.innerHTML = "";
			const maxChange = Math.max(...dataList.map(d => d.changeRate ? Math.abs(d.changeRate) : 0)) || 0.01;
			const maxDrop = Math.max(...dataList.map(d => d.dropRate ? Math.abs(d.dropRate) : 0)) || 0.01;

			dataList.forEach(item => {
				if (item.error) { tbody.innerHTML += `<tr><td>${item.name}</td><td colspan="15">Error</td></tr>`; return; }

				const action = getAction(item.price, item.targetPrice);
				const curr = isKorea ? "₩" : "$";
				const fmt = (n) => n ? n.toLocaleString(undefined, { maximumFractionDigits: isKorea ? 0 : 2 }) : "-";
				const fmtPct = (n) => n ? (n * 100).toFixed(2) + "%" : "0.00%";

				const changeColor = (item.changeRate || 0) < 0 ? "#0051c7" : "#e31b23";
				const changeW = (Math.abs(item.changeRate || 0) / maxChange) * 100;
				const dropW = (Math.abs(item.dropRate || 0) / maxDrop) * 100;

				let marketCap = item.marketCap || "-";
				if (marketCap.includes("조 ")) marketCap = marketCap.replace("조 ", "조<br>");

				/* [수정] 모든 셀에 툴팁 적용 */
				const tr = `
                    <tr>
                        <td><span class="stock-name" title="${item.name}">${item.name}</span><br><span style="font-size:11px; color:#999;">${item.ticker || item.code}</span></td>
                        <td class="input-val">${item.targetDiv ? item.targetDiv.toFixed(2) + "%" : ""}</td>
                        <td class="input-val">${item.targetPer || ""}</td>
                        <td style="text-align:center;"><span class="badge ${action.class}">${action.text}</span></td>
                        <td title="${curr}${fmt(item.targetPrice)}" style="color:#666;">${curr}${fmt(item.targetPrice)}</td>
                        <td title="${curr}${fmt(item.price)}" style="font-weight:700;">${curr}${fmt(item.price)}</td>
                        <td>
                            <div class="graph-wrapper">
                                <span class="${(item.changeRate || 0) > 0 ? 'up' : (item.changeRate || 0) < 0 ? 'down' : ''}">${fmtPct(item.changeRate)}</span>
                                <div class="bar-track"><div class="bar-fill" style="width:${changeW}%; background:${changeColor}; margin-${(item.changeRate || 0) < 0 ? 'left' : 'right'}:auto;"></div></div>
                            </div>
                        </td>
                        <td title="${curr}${fmt(item.high52)}">${curr}${fmt(item.high52)}</td>
                        <td>
                            <div class="graph-wrapper">
                                <span class="down">${fmtPct(item.dropRate)}</span>
                                <div class="bar-track"><div class="bar-fill" style="width:${dropW}%; background:#0051c7; margin-left:auto;"></div></div>
                            </div>
                        </td>
                        <td style="line-height:1.2; font-size:12px;">${marketCap}</td>
                        <td title="${item.per}">${item.per || '-'}</td>
                        <td title="${curr}${fmt(item.eps)}">${curr}${fmt(item.eps)}</td>
                        <td title="${item.pbr}">${item.pbr || '-'}</td>
                        <td title="${fmtPct(item.divYield)}" style="color:#e31b23; font-weight:600;">${fmtPct(item.divYield)}</td>
                        <td title="${curr}${fmt(item.divAmt)}">${curr}${fmt(item.divAmt)}</td>
                        <td title="${fmtPct(item.payout)}">${fmtPct(item.payout)}</td>
                    </tr>`;
				tbody.innerHTML += tr;
			});
		}

		function renderMobileList(container, dataList, isKorea) {
			container.innerHTML = "";
			const maxChange = Math.max(...dataList.map(d => d.changeRate ? Math.abs(d.changeRate) : 0)) || 0.01;
			const maxDrop = Math.max(...dataList.map(d => d.dropRate ? Math.abs(d.dropRate) : 0)) || 0.01;

			dataList.forEach(item => {
				if (item.error) return;
				const action = getAction(item.price, item.targetPrice);
				const curr = isKorea ? "₩" : "$";
				const fmt = (n) => n ? n.toLocaleString(undefined, { maximumFractionDigits: isKorea ? 0 : 2 }) : "-";
				const fmtPct = (n) => n ? (n * 100).toFixed(2) + "%" : "0.00%";

				const changeVal = item.changeRate || 0;
				const dropVal = item.dropRate || 0;
				const changeColor = changeVal < 0 ? "#0051c7" : "#e31b23";
				const changeW = Math.min((Math.abs(changeVal) / maxChange) * 100, 100);
				const dropW = Math.min((Math.abs(dropVal) / maxDrop) * 100, 100);

				const cardHtml = `
                    <div class="mobile-card">
                        <div class="m-header">
                            <div class="m-stock-info">
                                <h3>${item.name}</h3>
                                <span>${item.ticker || item.code}</span>
                            </div>
                            <span class="badge ${action.class}" style="font-size:14px; padding:6px 12px;">${action.text}</span>
                        </div>
                        <div class="m-body">
                            <div class="m-price-row">
                                <div class="m-current-price ${changeVal > 0 ? 'up' : (changeVal < 0 ? 'down' : '')}">
                                    ${curr}${fmt(item.price)}
                                </div>
                                <div class="m-target-price">
                                    목표가 <strong>${curr}${fmt(item.targetPrice)}</strong>
                                </div>
                            </div>
                            <div class="m-grid">
                                <div class="m-grid-item">
                                    <span class="m-grid-label">배당률</span>
                                    <span class="m-grid-value up">${fmtPct(item.divYield)}</span>
                                </div>
                                <div class="m-grid-item">
                                    <span class="m-grid-label">PER</span>
                                    <span class="m-grid-value">${item.per || '-'}</span>
                                </div>
                                <div class="m-grid-item">
                                    <span class="m-grid-label">52주 최고</span>
                                    <span class="m-grid-value">${curr}${fmt(item.high52)}</span>
                                </div>
                            </div>
                            <div class="m-footer">
                                <div class="m-bar-group">
                                    <div class="m-bar-label">
                                        <span>등락률</span>
                                        <span class="${changeVal > 0 ? 'up' : (changeVal < 0 ? 'down' : '')}">${fmtPct(changeVal)}</span>
                                    </div>
                                    <div class="m-bar-bg">
                                        <div class="m-bar-fill" style="width:${changeW}%; background-color:${changeColor}; margin-${changeVal < 0 ? 'left' : 'right'}: auto;"></div>
                                    </div>
                                </div>
                                <div class="m-bar-group">
                                    <div class="m-bar-label">
                                        <span>고점대비</span>
                                        <span class="down">${fmtPct(dropVal)}</span>
                                    </div>
                                    <div class="m-bar-bg">
                                        <div class="m-bar-fill" style="width:${dropW}%; background-color:#0051c7; margin-left: auto;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
				container.innerHTML += cardHtml;
			});
		}

		function switchTab(country) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			event.currentTarget.classList.add('active');
			document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
			document.getElementById(country).classList.add('active');
			const savedTime = window[`time_${country}`];
			document.getElementById('globalTime').innerText = savedTime || "업데이트 대기중...";
		}

		window.onload = () => {
			updateButtonState();
			fetchAndRender('korea');
			fetchAndRender('usa');
		};
	</script>
</body>

</html>
