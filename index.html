<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Stock Investment Plan</title>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

	<style>
		:root {
			--bg-body: #f5f7fa;
			--bg-card: #ffffff;
			--text-main: #333333;
			--text-sub: #666666;

			/* [ë””ìì¸] í…Œë‘ë¦¬ ìƒ‰ìƒ (ê¹”ë”í•œ íšŒìƒ‰) */
			--border-color: #dce1e6;

			/* [ë””ìì¸] ëª©í‘œ ì…ë ¥ë€ ë°°ê²½ìƒ‰ (íŠ€ì§€ ì•ŠëŠ” ì€ì€í•œ íšŒìƒ‰) */
			--input-bg: #f8f9fa;
			--input-text: #495057;

			/* [ë””ìì¸] í—¤ë” ë°°ê²½ */
			--header-bg: #f1f3f5;

			--color-up: #e31b23;
			--color-down: #0051c7;

			--badge-buy: #e31b23;
			--badge-sell: #0051c7;
			--badge-hold: #868e96;

			--tab-active-text: #111;
			--tab-inactive-bg: #ebTeff;
			--tab-inactive-text: #999;
		}

		body {
			font-family: 'Pretendard', sans-serif;
			background-color: var(--bg-body);
			margin: 0;
			padding: 40px 20px;
			color: var(--text-main);
		}

		.container {
			max-width: 1600px;
			margin: 0 auto;
		}

		/* --- í—¤ë” --- */
		.dashboard-header {
			margin-bottom: 20px;
			text-align: center;
		}

		.dashboard-title h2 {
			margin: 0;
			font-size: 28px;
			font-weight: 800;
			color: #2c3e50;
			letter-spacing: -0.5px;
		}

		/* --- íˆ´ë°” (íƒ­ ì˜ì—­) --- */
		.toolbar {
			display: flex;
			justify-content: space-between;
			align-items: flex-end;
			/* [ìˆ˜ì •] íŒ¨ë”© ì œê±° -> ì™¼ìª½ ë¼ì¸ ì™„ë²½ ì¼ì¹˜ */
			padding: 0;
			/* íƒ­ì´ ë³¸ë¬¸ ë³´ë” ìœ„ë¡œ ì˜¬ë¼ê°€ê²Œ */
			margin-bottom: -1px;
			position: relative;
			z-index: 10;
		}

		.tabs-group {
			display: flex;
			gap: 4px;
		}

		.tab-btn {
			padding: 12px 30px;
			border: 1px solid transparent;
			border-bottom: none;
			/* ë¹„í™œì„± íƒ­ ë°°ê²½ (íˆ¬ëª…í•˜ê±°ë‚˜ ì—°í•œ íšŒìƒ‰) */
			background: #e9ecef;
			border-radius: 12px 12px 0 0;
			font-size: 15px;
			font-weight: 600;
			color: var(--tab-inactive-text);
			cursor: pointer;
			transition: all 0.1s ease;
			display: flex;
			align-items: center;
			gap: 8px;
			position: relative;
		}

		.tab-btn:hover {
			background-color: #dee2e6;
			color: var(--text-main);
		}

		/* [í•µì‹¬ ìˆ˜ì •] í™œì„± íƒ­ ë””ìì¸ (ì¼ì²´ê°) */
		.tab-btn.active {
			background-color: var(--bg-card);
			color: var(--tab-active-text);
			font-weight: 700;
			/* í…Œë‘ë¦¬ ìƒ‰ìƒ í†µì¼ */
			border: 1px solid var(--border-color);
			/* í•˜ë‹¨ì„ í°ìƒ‰ìœ¼ë¡œ ë®ì–´ ë³¸ë¬¸ê³¼ ì—°ê²° */
			border-bottom: 1px solid var(--bg-card);
			z-index: 20;
			padding-bottom: 13px;
			/* ë†’ì´ ë³´ì • */
			box-shadow: 0 -2px 3px rgba(0, 0, 0, 0.02);
		}

		.flag-icon {
			font-size: 18px;
		}

		/* ì‹œê°„ í‘œì‹œ */
		.time-display {
			font-size: 13px;
			color: #666;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 6px;
			background: #fff;
			padding: 6px 16px;
			border-radius: 20px;
			border: 1px solid var(--border-color);
			margin-bottom: 8px;
			/* íƒ­ ë†’ì´ì™€ ê· í˜• */
		}

		.time-display i {
			color: #2c3e50;
		}

		/* --- ì»¨í…ì¸  ë°•ìŠ¤ --- */
		.content-section {
			display: none;
			background: var(--bg-card);
			border: 1px solid var(--border-color);
			/* ì™¼ìª½ ìœ„ëŠ” ì§ê°(íƒ­ ì—°ê²°), ë‚˜ë¨¸ì§€ëŠ” ë‘¥ê¸€ê²Œ */
			border-radius: 0 12px 12px 12px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
			padding: 20px;
			animation: fadeIn 0.2s ease-out;
			position: relative;
			z-index: 5;
		}

		.content-section.active {
			display: block;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(5px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* --- í…Œì´ë¸” ë””ìì¸ (Grid ìŠ¤íƒ€ì¼) --- */
		.table-responsive {
			overflow-x: auto;
			width: 100%;
			/* í…Œì´ë¸” ì™¸ê³½ì„  */
			border: 1px solid var(--border-color);
			border-radius: 8px;
		}

		table {
			width: 100%;
			/* sticky headerë¥¼ ìœ„í•´ separate ìœ ì§€í•˜ë˜ ê°„ê²©(spacing)ì„ 0ìœ¼ë¡œ */
			border-collapse: separate;
			border-spacing: 0;
			min-width: 1400px;
		}

		th {
			background-color: var(--header-bg);
			color: #333;
			font-weight: 700;
			padding: 14px 10px;
			text-align: center;
			/* í…Œë‘ë¦¬: ì•„ë˜ì™€ ì˜¤ë¥¸ìª½ */
			border-bottom: 1px solid var(--border-color);
			border-right: 1px solid var(--border-color);
			white-space: nowrap;
			position: sticky;
			top: 0;
			z-index: 10;
			font-size: 14px;
		}

		/* ë§ˆì§€ë§‰ í—¤ë” ì˜¤ë¥¸ìª½ ì„  ì œê±° */
		th:last-child {
			border-right: none;
		}

		td {
			padding: 12px 10px;
			/* í…Œë‘ë¦¬: ì•„ë˜ì™€ ì˜¤ë¥¸ìª½ */
			border-bottom: 1px solid var(--border-color);
			border-right: 1px solid var(--border-color);
			vertical-align: middle;
			text-align: right;
			font-size: 14px;
			white-space: nowrap;
			color: #333;
		}

		/* ë§ˆì§€ë§‰ ì—´ ì˜¤ë¥¸ìª½ ì„  ì œê±° */
		td:last-child {
			border-right: none;
		}

		/* ë§ˆì§€ë§‰ í–‰ ì•„ë˜ ì„  ì œê±° */
		tbody tr:last-child td {
			border-bottom: none;
		}

		/* í–‰ í˜¸ë²„ íš¨ê³¼ */
		tbody tr:hover td {
			background-color: #f8faff !important;
		}


		/* --- [ìˆ˜ì •] ëª©í‘œê°’ ì»¬ëŸ¼ ë””ìì¸ (ìì—°ìŠ¤ëŸ½ê²Œ) --- */
		/* ë°°ê²½ìƒ‰ì„ ì•„ì£¼ ì—°í•œ íšŒìƒ‰ìœ¼ë¡œ í•˜ì—¬ ì´ì§ˆê° ì œê±° */
		.input-val {
			background-color: var(--input-bg) !important;
			color: var(--input-text);
			/* í…Œë‘ë¦¬ ìƒ‰ìƒì€ ë‹¤ë¥¸ ì…€ê³¼ ë™ì¼í•˜ê²Œ í•˜ì—¬ í†µì¼ê° ë¶€ì—¬ */
			border-right: 1px solid var(--border-color);
		}

		/* ì…ë ¥ê°’ í—¤ë” */
		th.input-val {
			background-color: #e9ecef;
			/* í—¤ë”ë³´ë‹¤ ì‚´ì§ ì§„í•˜ê²Œ */
			color: #333;
		}


		/* --- ê³ ì • ì»¬ëŸ¼ (ê¸°ì—…ëª…) --- */
		th:first-child,
		td:first-child {
			position: sticky;
			left: 0;
			z-index: 20;
			background-color: #fff;
			/* ì˜¤ë¥¸ìª½ í…Œë‘ë¦¬ë¥¼ ì¡°ê¸ˆ ë” ì§„í•˜ê²Œ ì£¼ì–´ êµ¬ë¶„ê° í˜•ì„± */
			border-right: 1px solid #bdc3c7;
			text-align: left;
			padding-left: 20px;
		}

		th:first-child {
			z-index: 30;
			background-color: var(--header-bg);
			/* íƒ­ ì—°ê²° ë¶€ìœ„: ì™¼ìª½ ìœ„ ë‘¥ê¸€ê¸° ì œê±° */
			border-top-left-radius: 0;
		}

		/* ê¸°ì—…ëª… í…ìŠ¤íŠ¸ */
		.stock-name {
			font-weight: 700;
			color: #212529;
			font-size: 15px;
			display: block;
		}

		.stock-code {
			font-size: 12px;
			color: #adb5bd;
			margin-top: 4px;
			display: block;
			font-weight: 400;
		}


		/* --- UI ìš”ì†Œ --- */
		.badge {
			display: inline-block;
			padding: 6px 12px;
			border-radius: 6px;
			font-size: 12px;
			font-weight: 700;
			color: white;
			text-align: center;
			min-width: 52px;
		}

		.badge.buy {
			background: var(--badge-buy);
		}

		.badge.sell {
			background: var(--badge-sell);
		}

		.badge.hold {
			background-color: var(--badge-hold);
			opacity: 0.8;
		}

		.badge.nodata {
			background-color: #e9ecef;
			color: #adb5bd;
		}

		.up {
			color: var(--color-up);
			font-weight: 700;
		}

		.down {
			color: var(--color-down);
			font-weight: 700;
		}

		.price-text {
			font-family: 'Roboto', sans-serif;
			font-weight: 600;
		}

		.graph-wrapper {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 10px;
			width: 140px;
			margin-left: auto;
		}

		.graph-text {
			width: 50px;
			text-align: right;
			font-size: 13px;
		}

		.bar-track {
			flex-grow: 1;
			height: 6px;
			background-color: #eee;
			border-radius: 3px;
			overflow: hidden;
			display: flex;
			position: relative;
		}

		.bar-fill {
			height: 100%;
			border-radius: 3px;
			transition: width 0.5s ease;
		}

		.loading-row td {
			text-align: center;
			color: #999;
			padding: 60px;
			border: none;
		}

		.spinner {
			display: inline-block;
			width: 24px;
			height: 24px;
			border: 3px solid rgba(0, 0, 0, 0.1);
			border-radius: 50%;
			border-top-color: #2c3e50;
			animation: spin 1s ease-in-out infinite;
			vertical-align: middle;
			margin-right: 10px;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		@media (max-width: 768px) {
			.container {
				margin: 0;
			}

			.toolbar {
				flex-direction: column-reverse;
				align-items: flex-start;
				gap: 10px;
				padding: 0;
			}

			.time-display {
				width: 100%;
				justify-content: center;
				background: #fff;
				margin-bottom: 0;
			}

			.tabs-group {
				width: 100%;
				gap: 8px;
			}

			.tab-btn {
				flex: 1;
				justify-content: center;
				border-radius: 12px;
				border: 1px solid var(--border-color);
				background: #fff;
			}

			.tab-btn.active {
				background: #2c3e50;
				color: #fff;
				border: none;
			}

			td:first-child {
				padding-left: 15px;
			}
		}
	</style>
</head>

<body>

	<div class="container">
		<div class="dashboard-header">
			<div class="dashboard-title">
				<h2>Stock Investment Plan <span>í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©</span></h2>
			</div>
		</div>

		<div class="toolbar">
			<div class="tabs-group">
				<button class="tab-btn active" onclick="switchTab('korea')">
					<span class="flag-icon">ğŸ‡°ğŸ‡·</span> í•œêµ­ ì£¼ì‹
				</button>
				<button class="tab-btn" onclick="switchTab('usa')">
					<span class="flag-icon">ğŸ‡ºğŸ‡¸</span> ë¯¸êµ­ ì£¼ì‹
				</button>
			</div>
			<div class="time-display">
				<i class="far fa-clock"></i>
				<span id="globalTime">ì—…ë°ì´íŠ¸ ëŒ€ê¸°ì¤‘...</span>
			</div>
		</div>

		<div id="korea" class="content-section active">
			<div class="table-responsive">
				<table id="tableKorea">
					<thead>
						<tr>
							<th>ê¸°ì—…ëª…</th>
							<th class="input-val">ëª©í‘œ<br>ë°°ë‹¹ë¥ (%)</th>
							<th class="input-val">ëª©í‘œ<br>PER(ë°°)</th>
							<th>Action</th>
							<th>ëª©í‘œê°€</th>
							<th>í˜„ì¬ê°€</th>
							<th>ë“±ë½ë¥ </th>
							<th>52ì£¼ ìµœê³ </th>
							<th>ê³ ì  ëŒ€ë¹„</th>
							<th>ì‹œê°€ì´ì•¡</th>
							<th>PER</th>
							<th>EPS</th>
							<th>PBR</th>
							<th>ë°°ë‹¹ë¥ </th>
							<th>ë°°ë‹¹ê¸ˆ</th>
							<th>ë°°ë‹¹ì„±í–¥</th>
						</tr>
					</thead>
					<tbody id="tbodyKorea"></tbody>
				</table>
			</div>
		</div>

		<div id="usa" class="content-section">
			<div class="table-responsive">
				<table id="tableUSA">
					<thead>
						<tr>
							<th>ê¸°ì—…ëª…</th>
							<th class="input-val">ëª©í‘œ<br>ë°°ë‹¹ë¥ (%)</th>
							<th class="input-val">ëª©í‘œ<br>PER(ë°°)</th>
							<th>Action</th>
							<th>ëª©í‘œê°€</th>
							<th>í˜„ì¬ê°€</th>
							<th>ë“±ë½ë¥ </th>
							<th>52ì£¼ ìµœê³ </th>
							<th>ê³ ì  ëŒ€ë¹„</th>
							<th>ì‹œê°€ì´ì•¡<br><span style="font-weight:400; color:#999; font-size:0.85em">(AUM)</span></th>
							<th>PER</th>
							<th>EPS</th>
							<th>PBR</th>
							<th>ë°°ë‹¹ë¥ </th>
							<th>ë°°ë‹¹ê¸ˆ</th>
							<th>ë°°ë‹¹ì„±í–¥</th>
						</tr>
					</thead>
					<tbody id="tbodyUSA"></tbody>
				</table>
			</div>
		</div>
	</div>

	<script>
		// ============================================================
		// 1. [ì„¤ì •] Google Apps Script URL
		// ============================================================
		const API_URL = "https://script.google.com/macros/s/AKfycbz80x6AyIftaDyqX68cyv3spp2x8gg14Rq1gPnb8NSToi0LInPgOkBbn2lflJSkd_8u/exec";

		// ============================================================
		// 2. [ì„¤ì •] ì¢…ëª© ë° ëª©í‘œ ì„¤ì •
		// ============================================================
		const koreaStocks = [
			{ name: "ê¸°ì•„", code: "000270", targetDiv: 6.00, targetPer: null },
			{ name: "ì‚¼ì„±ì¦ê¶Œ", code: "016360", targetDiv: 5.00, targetPer: null },
			{ name: "KT&G", code: "033780", targetDiv: 4.00, targetPer: null },
			{ name: "í•œì „KPS", code: "051600", targetDiv: 5.00, targetPer: null },
			{ name: "ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼", code: "138040", targetDiv: null, targetPer: 10 }
		];

		const usaStocks = [
			{ name: "Cisco Systems", code: "CSCO", targetDiv: 3.00, targetPer: null },
			{ name: "Coca-Cola", code: "KO", targetDiv: 3.00, targetPer: null },
			{ name: "Realty Income", code: "O", targetDiv: 6.00, targetPer: null },
			{ name: "Pfizer", code: "PFE", targetDiv: 7.00, targetPer: null },
			{ name: "iShares 20+ Year Treasury Bond ETF", code: "TLT", targetDiv: 4.30, targetPer: null }
		];

		// ============================================================
		// 3. ë¡œì§ í•¨ìˆ˜
		// ============================================================
		function calculateTarget(data, config) {
			try {
				if (config.targetDiv) {
					if (!data.divAmt) return 0;
					return data.divAmt / (config.targetDiv / 100);
				}
				if (config.targetPer) {
					if (!data.eps) return 0;
					return data.eps * config.targetPer;
				}
				return "no data";
			} catch (e) {
				return "err";
			}
		}

		function getAction(current, target) {
			if (typeof target === 'string') return { text: "íŒë‹¨ë¶ˆê°€", class: "nodata" };
			if (!current) return { text: "ë¡œë”©ì¤‘", class: "nodata" };

			if (current < target) return { text: "ë§¤ìˆ˜", class: "buy" };
			else if (current > target * 1.2) return { text: "ë§¤ë„", class: "sell" };
			else return { text: "ë³´ìœ ", class: "hold" };
		}

		async function fetchAndRender(country) {
			const tableId = country === 'korea' ? 'tbodyKorea' : 'tbodyUSA';
			const stockList = country === 'korea' ? koreaStocks : usaStocks;
			const tbody = document.getElementById(tableId);
			const isKorea = country === 'korea';

			tbody.innerHTML = `<tr class="loading-row"><td colspan="16"><div class="spinner"></div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>`;

			const promises = stockList.map(item =>
				fetch(`${API_URL}?ticker=${item.code}`)
					.then(res => res.json())
					.then(data => {
						const calculatedTarget = calculateTarget(data, item);
						return { ...data, name: item.name, targetDiv: item.targetDiv, targetPer: item.targetPer, targetPrice: calculatedTarget };
					})
					.catch(err => ({ ...item, error: true }))
			);

			try {
				const rowDataList = await Promise.all(promises);

				const validData = rowDataList.find(d => !d.error && d.time);
				if (validData) {
					const timeStr = validData.time;
					window[`time_${country}`] = timeStr;
					if (document.querySelector('.tab-btn.active').innerText.includes(isKorea ? "í•œêµ­" : "ë¯¸êµ­")) {
						document.getElementById('globalTime').innerText = timeStr;
					}
				}
				renderTableBody(tbody, rowDataList, isKorea);

			} catch (error) {
				tbody.innerHTML = `<tr><td colspan="16" style="text-align:center;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
			}
		}

		function renderTableBody(tbody, dataList, isKorea) {
			tbody.innerHTML = "";
			const maxChange = Math.max(...dataList.map(d => d.changeRate ? Math.abs(d.changeRate) : 0)) || 0.01;
			const maxDrop = Math.max(...dataList.map(d => d.dropRate ? Math.abs(d.dropRate) : 0)) || 0.01;

			dataList.forEach(item => {
				if (item.error) {
					tbody.innerHTML += `<tr><td>${item.name}</td><td colspan="15">í˜¸ì¶œ ì‹¤íŒ¨</td></tr>`;
					return;
				}

				const action = getAction(item.price, item.targetPrice);
				const currency = isKorea ? "â‚©" : "$";
				const fmt = (n) => n ? n.toLocaleString(undefined, { maximumFractionDigits: 0 }) : "-";
				const fmtUsd = (n) => n ? n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "-";
				const fmtPct = (n) => n ? (n * 100).toFixed(2) + "%" : "0.00%";

				const displayPrice = isKorea ? fmt(item.price) : fmtUsd(item.price);
				const displayTarget = typeof item.targetPrice === 'number' ? (isKorea ? fmt(item.targetPrice) : fmtUsd(item.targetPrice)) : "-";

				const changeVal = item.changeRate || 0;
				const changeColor = changeVal < 0 ? "#0051c7" : "#e31b23";
				const changeWidth = (Math.abs(changeVal) / maxChange) * 100;

				const dropVal = item.dropRate || 0;
				const dropColor = "#0051c7";
				const dropWidth = (Math.abs(dropVal) / maxDrop) * 100;

				let marketCapDisplay = item.marketCap;
				if (marketCapDisplay && marketCapDisplay.includes("ì¡° ")) {
					marketCapDisplay = marketCapDisplay.replace("ì¡° ", "ì¡°<br>");
				}

				const tr = `
                    <tr>
                        <td>
                            <span class="stock-name">${item.name}</span>
                            <span class="stock-code">${item.ticker || item.code}</span>
                        </td>
                        <td class="input-val">${item.targetDiv ? item.targetDiv.toFixed(2) + "%" : ""}</td>
                        <td class="input-val">${item.targetPer ? item.targetPer : ""}</td>
                        
                        <td style="text-align:center;"><span class="badge ${action.class}">${action.text}</span></td>
                        <td class="price-text" style="color:#2c3e50;">${currency}${displayTarget}</td>
                        <td class="price-text" style="font-weight:700;">${currency}${displayPrice}</td>
                        
                        <td>
                            <div class="graph-wrapper">
                                <span class="graph-text ${changeVal > 0 ? 'up' : (changeVal < 0 ? 'down' : '')}">${fmtPct(changeVal)}</span>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width:${changeWidth}%; background-color:${changeColor}; margin-${changeVal < 0 ? 'left' : 'right'}: auto;"></div>
                                </div>
                            </div>
                        </td>

                        <td class="price-text">${currency}${isKorea ? fmt(item.high52) : fmtUsd(item.high52)}</td>

                        <td>
                            <div class="graph-wrapper">
                                <span class="graph-text down">${fmtPct(dropVal)}</span>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width:${dropWidth}%; background-color:${dropColor}; margin-left: auto;"></div>
                                </div>
                            </div>
                        </td>

                        <td style="line-height:1.3">${marketCapDisplay}</td>
                        <td>${item.per || '-'}</td>
                        <td class="price-text">${isKorea ? 'â‚©' : '$'}${isKorea ? fmt(item.eps) : fmtUsd(item.eps)}</td>
                        <td>${item.pbr || '-'}</td>
                        <td style="color:#e31b23; font-weight:600;">${fmtPct(item.divYield)}</td>
                        <td class="price-text">${isKorea ? 'â‚©' : '$'}${isKorea ? fmt(item.divAmt) : fmtUsd(item.divAmt)}</td>
                        <td>${fmtPct(item.payout)}</td>
                    </tr>
                `;
				tbody.innerHTML += tr;
			});
		}

		function switchTab(country) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			event.currentTarget.classList.add('active');
			document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
			document.getElementById(country).classList.add('active');

			const savedTime = window[`time_${country}`];
			document.getElementById('globalTime').innerText = savedTime || "ì—…ë°ì´íŠ¸ ì¤‘...";
		}

		window.onload = () => {
			fetchAndRender('korea');
			fetchAndRender('usa');
		};
	</script>
</body>

</html>
